# 今年一番のサイドプロダクト

- 自己紹介
- FOLIOの紹介

今日はそんなFOLIOの開発について
ではなく
FOLIO初の社内プロジェクトについてお話しします

名刺、どうやって作ってますか？

（おそらく）デザイナーさんが頑張ってIllustratorで作っているんじゃないでしょうか・・・
うちはそうでした

会社「今度引っ越すから全員分の名刺の住所アップデートよろ」
デザイナー「名刺に工数割かれたくない人生だった・・・」
デザイナー「そうだ！名刺データ作るの自動化できれば解決じゃん」

→よしこ入社

デザイナー「かくかくしかじか」
よしこ「うーん・・・とりあえずやってみる」

できました

MEICY

[ここで実際の動きをdemo ※社員情報はダミーに差し替え]

# 使用技術

- Vue.js
- flow
- docker
- rails (API)

大変だったことを3つ紹介します

# 1. 解像度

一番最初に思ったのが
「Webベースでやるとしたら、解像度足りんのかな…」

印刷物の解像度はだいたい350dpi以上
Webで使うような画像の解像度はだいたい72dpi

dpi = dot per inch
1インチにいくつのドットを入れて表示するか？
最近は2xとか3xとかあるので、dpp (dot per pixel)っていうらしい

インチと相互変換できる実寸のサイズ（cm, mm）とdpiが決まれば、何px必要なのかわかる

名刺のサイズは91mm x 55mm （+塗り足し6mmぐらい）
91mm x 55mmで350dpiだと1254x758になるpx
名刺部分が1254x758pxになるように画像を書き出せればいけそう

# 2. 画像ファイルの書き出し

AIファイルとかだと無理だけど、幸いPDF入稿が可能な印刷所だったためPDFで

Webフロントエンドだけでどうやって画像を書き出すか？
ここは個人的に何度もやったことがあって知見があった（Prott 画面遷移図、参加者の名は）

## 流れ
名刺部分をブラウザ上でレンダリング（= CSS使える）
html2canvasでcanvas化
用意しておいたテンプレートのjpgの上に
toDataUrlでJPGにしたものを用意しておいたテンプレートのjpnの上に配置してjspdfでPDF化

HTML + CSSで再現すればいいならこっちのもんっしょ！
名刺データはテキスト中心だしよゆーよゆー

# 3. プレビューサイズと書き出しサイズの乖離

せっかくWebアプリなこともあり、画像を書き出す前に、画面上でリアルタイムプレビューをしたい
プレビュー = 画面に表裏がおさまるサイズ（横400pxぐらい）
書き出し = 1254x758

1254x758 なんて横に2つ並ぶわけない…プレビューと書き出しでサイズを切り替えなければ
でもプレビュー用の要素と書き出し用の要素それぞれ作るのは絶対イヤだ！！変更あったときそれぞれ修正しなきゃいけないしめんどくさすぎる！！！

解決策
まず書き出し用のサイズでコーディング
プレビューのときには transform: scale(0.26) で縮小
実際は横1254pxの名刺部分が326pxぐらいになる（画面に名刺をあてたときちょうど同じぐらいの大きさ）
プレビューと書き出し用の要素が同じなので保守性も上がる

```
$mm: 14px;

.card {
position: absolute;
width: 91 * $mm;
height: 55 * $mm;
padding: 5.5 * $mm;
border-radius: 2.5 * $mm;
transform: scale(0.26);
background: no-repeat center center;
font-family: URWDIN, MB101;
font-size: 2.4 * $mm;
line-height: 1;
}
```

こんなファイルができるようになりました〜（PDFを見せる）

# 4. フォント

jspdfはいくつかのフォントを勝手に埋め込んでしまうらしく、そのフォントがインストールされていないので開けないと印刷所から連絡
JPGにしてからPDFにしてるから一度も文字使ってないのに！！！
内部のコードを見ると、初期化の中でaddFontしておりだめだこりゃ

# 5. 解像度（2回目）

フォント情報を手で取り除き再送。待ってる間にForkして直してPRでもだそうかと思ったら

印刷所「サイズ違います。デカすぎ」

どうやら4092x2893(72dpi)のものをdpi変更して841x595(350dpi)にしないといけないのに、4092x2893(72dpi)のまま送ってしまっているから怒られているらしい
dpi変更までこちらでやらなければ

しかし調べてもフロントだけで画像の解像度を変更する方法が見つからなかった
jspdfで縮小してから書き出すと線がガタガタに。。（ここ記憶曖昧なので本当にそうだったか要再確認）
imageMagickに移行

`convert -density 350 -quality 100 ~/Downloads/meicy.jpg ~/Downloads/meicy.pdf`

うまくいった〜〜〜〜〜
しかしサーバーサイドが必要なのでimagemagick-railsのイメージでさくっと
ここでdockerをdocker-composeに移行

# 6. letter-spacing

letter-spacingがちゃんと反映されない問題

html2canvasの再現度はすごいが、文字間だけはうまくいかなかった
optionにletterRendering: trueが必要でした


完成！！！！！！！！！！！！！！！！！！！
デザイナーの工数はゼロ
管理部のほうで入力できるようになり、とっても楽になりました














