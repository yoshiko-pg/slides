<html>
<head>
  <title>AngularJSのWatch数が60,000だった - @yoshiko_pg</title>
  <link rel="stylesheet" href="lib/talkie.min.css">
  <link rel="stylesheet" href="lib/talkie-default.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="lib/hljs-styles/railscasts.css">
</head>
<body>


<script layout="cover" invert type="text/x-markdown"
  backface="image/cover.jpg" backface-filter="blur(2px) brightness(.7)">
# AngularJSのWatch数が60,000だった

2015.10.15 [@yoshiko_pg](http://yoshiko-pg.github.io)

[Goodpatch Engineer Meetup Vol.1](http://goodpatch.connpass.com/event/20857/)
</script>


<script layout="bullets" invert type="text/x-markdown"
  backface="image/bg-profile.png" backface-filter="blur(2px) brightness(.4)">

## 自己紹介

<img src="./image/yoshiko.png" class="yoshiko">

よしこ [@yoshiko_pg](https://twitter.com/yoshiko_pg)

Frontend engineer at <a href="http://goodpatch.com/jp"><img src="./image/goodpatch.png" class="company-logo"></a>

</script>


<script layout="bullets" type="text/x-markdown" class="m0">
### 今日話すこと

　

* AngularJSのパフォーマンスを改善した思い出
  * Watch数を減らすのに有効な施策
  * 重くなりがちなアンチパターン
</script>


<script layout type="text/x-markdown" class="m0">
2015年6月1日

　

フロントエンドエンジニアとしてGoodpatchに入社しました
</script>


<script layout="cover" invert type="text/x-markdown"
  backface="image/prott.png" backface-filter="">
</script>


<script layout="bullets" type="text/x-markdown">
## Prott

* Web App
* iOS App
* Android App
* Mac App
</script>


<script layout="bullets" type="text/x-markdown">
## Prott Web

* AngularJS
* CoffeeScript
* Jade
* Sass (SCSS)
</script>


<script layout="bullets-invert" type="text/x-markdown">
## 入社して最初のミッション
</script>


<script layout="bullets" type="text/x-markdown">
## 「Prott重いんだよね」
</script>


<script layout="bullets" type="text/x-markdown">
## 「パフォーマンスチューニングよろしく！」
</script>


<script layout="bullets-invert" type="text/x-markdown"
  backface="image/nya.jpg" backface-filter="blur(1px) brightness(.5)">
## なるほど
</script>


<script layout="bullets" type="text/x-markdown">
## とりあえず現状把握
</script>


<script layout="bullets" type="text/x-markdown">
Angularが重くなる代表的な原因のひとつ

　

### Watch多すぎ問題
</script>

<!--
ここに双方向バインディングとダイジェストループの説明入れるか悩む。
-->


<script layout="bullets" type="text/x-markdown">
指標としては2,000個以下に保っておきたいところ

*[AngularJSのパフォーマンス改善入門](http://qiita.com/zoetro/items/5156aef51222e81dd022)*
</script>


<script layout="bullets" type="text/x-markdown">
Watch数調査にはChrome拡張を使用すると便利
</script>


<script layout invert type="text/x-markdown"
  backface="image/angular-watchers.png" backface-filter="blur(1px) brightness(.3)">
### [Angular watchers](https://chrome.google.com/webstore/detail/angular-watchers/nlmjblobloedpmkmmckeehnbfalnjnjk)

調べたいページで開発者ツールのタブを開くだけで
Watch数がわかるすぐれもの  
　  
潔いほどの単機能
</script>


<script layout invert type="text/x-markdown"
  backface="image/angular-batarang.png" backface-filter="blur(1px) brightness(.3)">
### [AngularJS Batarang](https://chrome.google.com/webstore/detail/angularjs-batarang/ighdmehidhipcmcojjgiloacoafjmpfk)

こっちはとても有名なんですが  
去年辺りから使えないようです
</script>


<script layout="bullets-invert" type="text/x-markdown">
## いざ調査！
</script>


<script layout="bullets" type="text/x-markdown">
## 特に重かった画面

* プロジェクト一覧画面
* グループ機能画面
</script>


<script layout invert type="text/x-markdown"
  backface="image/prott-projects.png" backface-filter="blur(1px) brightness(.4)">
## プロジェクト一覧画面
## Watch数 約**23,000**

*※プロジェクト660件表示時*
</script>

<script layout invert type="text/x-markdown"
  backface="image/prott-groups.png" backface-filter="blur(1px) brightness(.4)">
## グループ画面は・・・？

*※ メンバー102名・プロジェクト360個・グループ22個の場合*
</script>


<script layout invert type="text/x-markdown" backface="image/prott-groups-real.png">
</script>


<script layout invert type="text/x-markdown" backface="image/baba--n.png">
</script>


<script layout="bullets-invert" type="text/x-markdown"
  backface="image/nya.jpg" backface-filter="blur(1px) brightness(.5)">
## どうしてこうなった
</script>


<script layout="bullets" type="text/x-markdown">
### 入社5日目の日報

![](image/nippou.png)
</script>


<script layout="bullets-invert" type="text/x-markdown">
なにはともあれ
膨らんだWatch数を減らすには
</script>


<script layout="cover" invert type="text/x-markdown"
  backface="image/don.jpg" backface-filter="blur(2px) brightness(.4)">
#  One Time Binding
</script>


<script layout="bullets-invert" type="text/x-markdown">
##  One Time Binding

* 一度Watch対象の値を認識したら、  
それ以降の監視を行わない機能。  
* 一度決まれば二度と変動しない値に使用することで  
パフォーマンスを改善できる
</script>


<script layout="code" type="text/x-markdown">
##  One Time Binding

```javaScript
// 何度も更新される(ng-bindなどでも同様)
{{hoge}}

// 一度値が決まれば更新されない
{{::hoge}}
```

※ ただし使えるのはAngularJS 1.3以降
</script>


<script layout="bullets" type="text/x-markdown">
当時のProttはAngularJS 1.2
</script>


<script layout="bullets-invert" type="text/x-markdown"
  backface="image/nya.jpg" backface-filter="blur(1px) brightness(.5)">
## だめじゃん
</script>


<script layout="bullets" type="text/x-markdown">
ということで最初の仕事は  
AngularJSのバージョンアップになりました
</script>


<script layout="bullets-invert" type="text/x-markdown">
### AngularJS 1.2 → 1.3 の注意点

* ``'false'`` ``'0'`` ``'no'`` ``'n'`` ``'f'`` ``'[]'`` がfalsyでなくなる
  * JS同様、``false`` ``null`` ``undefined`` ``NaN`` ``0`` ``""`` のみ falsyに
* $animateの仕様変更によりCSSにも修正が必要
* Directiveのreplaceが非推奨に
* IE8が対象外に

*その他：[AngularJS: Migrating from 1.2 to 1.3 日本語訳](http://angularjsninja.com/blog/2014/10/15/migrating-from-1.2-to-1.3-in-Japanese/)*
</script>


<script layout="bullets" type="text/x-markdown">
意外とすんなり上げられました  


むしろ同時にCoffeeScriptのバージョンを  
上げたことによるエラーの方が多かった
</script>


<script layout="bullets" type="text/x-markdown">
## 言語とフレームワーク
## 同時バージョンアップ
## ダメ絶対

*切り分けが面倒なので*
</script>


<script layout="bullets-invert" type="text/x-markdown">
### バージョンも上がったので
### One Time Bindingを適用
</script>


<script layout="code" type="text/x-markdown">
### angular-translateに一括適用

[angular-translate](https://angular-translate.github.io/)

```javaScript
.title {{"USER_DIALOG.MY_ACCOUNT" | translate}}
// ↓
.title {{::"USER_DIALOG.MY_ACCOUNT" | translate}}
```

Prottのテキストは多言語対応のため  
すべてangular-translateを通しています

*こんなのも：[angular-translate-once](http://atticuswhite.com/blog/angularjs-translate-once-angular-translate-one-time-binding/)*
</script>


<script layout="code" type="text/x-markdown">
### 目視でwatchが不要なところに適用

セミコロンをふたつつけるだけの  
簡単なお仕事です
</script>


<script layout invert type="text/x-markdown"
  backface="image/prott-groups.png" backface-filter="blur(1px) brightness(.4)">
## グループ画面
## Watch数 約**60,000**
↓
## Watch数 約**27,000**
</script>


<script layout="bullets-invert" type="text/x-markdown">
### One Time Binding

* angular-translateに一括適用
  * 引数がある場合もあるので注意
* 目視でwatchが不要なところに適用
  * ng-repeatの中とか効果大

### Watch数 -33,000
</script>


<script layout="bullets" type="text/x-markdown">
## 次の手

* ng-hide → ng-if
* ng-repeat内のイベントハンドラを駆逐
</script>


<script layout="bullets" type="text/x-markdown">
### ng-hide → ng-if

* ng-hide
  * display: none; をかけて見えなくする  
* ng-if
  * HTML自体が出たり消えたりする

大きめのブロックをトグルするときなどは  
ng-ifを使ったほうが軽いです

※ ng-ifは新たなchild Scopeができてしまうことに注意
</script>


<script layout="bullets" type="text/x-markdown">
### ng-repeat内の<br>イベントハンドラを駆逐

ng-repeatで数百件ぐらい回す中にいくつもng-clickなどのイベントハンドラがあると**めちゃ重**になりがち

親の要素ひとつだけに指定して、コールバックの中で  
対象要素を絞り込むことで回避できる
</script>


<script layout="code" type="text/x-markdown">
```javascript
// コードかく
```
</script>


<script layout invert type="text/x-markdown"
  backface="image/prott-groups.png" backface-filter="blur(1px) brightness(.4)">
## グループ画面
## Watch数 約**27,000**
↓
## Watch数 約**1,700**
</script>


<script layout="bullets-invert" type="text/x-markdown">
# 最終的に
</script>


<script layout invert type="text/x-markdown"
  backface="image/prott-groups.png" backface-filter="blur(1px) brightness(.4)">
## グループ画面
## Watch数 約**60,000**
↓
## Watch数 約**1,700**
</script>


<script layout="title" invert type="text/x-markdown"
  backface="image/don.jpg" backface-filter="blur(2px) brightness(.4)">
#  2.8%
## 1/35になりました
</script>

<script layout="bullets-invert" type="text/x-markdown">
## まとめ
</script>


<script layout="bullets" type="text/x-markdown">
### 肥大したWatch数の対処

* One Time Binding
  * AngularJS 1.3〜
  * angular-translateをざざっと
  * 他のところは目視でがんばる
* ng-hide → ng-if
* ng-repeat内のイベントハンドラを駆逐
</script>


<script layout="bullets" type="text/x-markdown">
## 今後もどんどん
## 軽くしていきます！！
</script>

<!--
* リンク色明るくする
* ng-ifにするときScope要注意
* 最終的な差をグラフ
  * 約-98%
* $digest loopの話はスライド入れる
* Wachについても
  * ここに双方向バインディングとダイジェストループの説明入れるか悩む。→いれる
-->


<script layout="cover" invert type="text/x-markdown"
  backface="image/nya.jpg" backface-filter="blur(1px) brightness(.5)">
# Thank you
[@yoshiko_pg](http://yoshiko-pg.github.io/)
</script>


<script src="lib/highlight.min.js"></script>
<script src="lib/talkie.min.js"></script>
<script>
Talkie();

// リンクは別タブ
var i, links = document.querySelectorAll("a[href^='http']")
for(i=0; i<links.length; i++) {
  links[i].setAttribute('target', '_blank');
}
</script>
</script>
</body>
</html>
